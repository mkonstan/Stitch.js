<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nested Computed Properties Test - Stitch.js</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 40px;
            background: #f5f5f5;
            color: #333;
        }

        h1 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .description {
            margin-bottom: 30px;
            color: #666;
            font-size: 14px;
        }

        #test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            background: #fafafa;
        }

        .user-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        button {
            padding: 6px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        .debug-info {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 4px;
        }

        .debug-info h3 {
            margin-bottom: 10px;
            color: #856404;
        }

        .debug-info p {
            margin: 5px 0;
            font-size: 13px;
            color: #856404;
        }

        .success {
            color: #28a745;
            font-weight: bold;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üß™ Nested Computed Properties Test</h1>
    <p class="description">
        Testing foreach loops with nested objects containing computed properties.<br>
        Expected: User full names and statuses should display without console errors.
    </p>

    <div id="test-container">
        <!-- Template will be repeated for each user -->
        <div class="user-card" data-foreach="users">
            <h4 data-text="fullName"></h4>
            <div class="user-info">
                <span class="status-badge" data-text="statusLabel" data-class="statusClass"></span>
                <button data-click="$parent.toggleStatus">Toggle Status</button>
            </div>
        </div>
    </div>

    <div class="debug-info">
        <h3>Debug Information</h3>
        <p id="status">‚è≥ Initializing...</p>
        <p id="error-count"></p>
        <p>Check browser console for detailed logs</p>
    </div>

    <script src="stitch.js"></script>
    <script>
        // Enable full debug logging
        Stitch.debug.enable();

        console.log('üöÄ Starting Nested Computed Properties Test');
        console.log('='.repeat(50));

        // Track console errors
        let errorCount = 0;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.error = function(...args) {
            errorCount++;
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            if (args[0] && args[0].includes('does not exist')) {
                errorCount++;
            }
            originalWarn.apply(console, args);
        };

        try {
            // Create model with nested computed properties in array
            const model = Stitch.Observable.create({
                users: [
                    {
                        id: 1,
                        firstName: 'Alice',
                        lastName: 'Anderson',
                        isActive: true,

                        // NESTED COMPUTED - fullName
                        fullName: Stitch.computed(function() {
                            console.log('  üìä Computing fullName for:', this.firstName);
                            return `${this.firstName} ${this.lastName}`;
                        }),

                        // NESTED COMPUTED - status label
                        statusLabel: Stitch.computed(function() {
                            return this.isActive ? 'Active' : 'Inactive';
                        }),

                        // NESTED COMPUTED - status CSS class
                        statusClass: Stitch.computed(function() {
                            return this.isActive ? 'status-active' : 'status-inactive';
                        })
                    },
                    {
                        id: 2,
                        firstName: 'Bob',
                        lastName: 'Brown',
                        isActive: true,

                        fullName: Stitch.computed(function() {
                            console.log('  üìä Computing fullName for:', this.firstName);
                            return `${this.firstName} ${this.lastName}`;
                        }),

                        statusLabel: Stitch.computed(function() {
                            return this.isActive ? 'Active' : 'Inactive';
                        }),

                        statusClass: Stitch.computed(function() {
                            return this.isActive ? 'status-active' : 'status-inactive';
                        })
                    },
                    {
                        id: 3,
                        firstName: 'Charlie',
                        lastName: 'Chen',
                        isActive: false,

                        fullName: Stitch.computed(function() {
                            console.log('  üìä Computing fullName for:', this.firstName);
                            return `${this.firstName} ${this.lastName}`;
                        }),

                        statusLabel: Stitch.computed(function() {
                            return this.isActive ? 'Active' : 'Inactive';
                        }),

                        statusClass: Stitch.computed(function() {
                            return this.isActive ? 'status-active' : 'status-inactive';
                        })
                    }
                ],

                // Toggle function accessible via $parent in foreach
                toggleStatus: function(e, context) {
                    console.log('üîÑ Toggling status for:', context.$data);
                    context.$data.isActive = !context.$data.isActive;
                }
            });

            console.log('‚úÖ Model created:', model);
            console.log('üìã Users array:', model.users);
            console.log('üîç First user:', model.users[0]);
            console.log('üîç First user properties:', Object.keys(model.users[0]));

            // Check if computed properties are getters
            const firstUser = model.users[0];
            const descriptor = Object.getOwnPropertyDescriptor(firstUser, 'fullName');
            console.log('üîç fullName property descriptor:', descriptor);

            if (descriptor && descriptor.get) {
                console.log('‚úÖ fullName is a getter function');
            } else {
                console.error('‚ùå fullName is NOT a getter - this is the bug!');
            }

            // Try accessing computed property directly
            try {
                const fullName = model.users[0].fullName;
                console.log('‚úÖ Directly accessed fullName:', fullName);
            } catch (err) {
                console.error('‚ùå Failed to access fullName:', err);
            }

            // Create and bind
            console.log('üîó Creating DataBinder...');
            const binder = new Stitch.DataBinder();

            console.log('üîó Binding to DOM...');
            binder.bind('#test-container', model);

            console.log('‚úÖ Binding complete!');
            console.log('='.repeat(50));

            // Update status
            setTimeout(() => {
                const statusEl = document.getElementById('status');
                const errorCountEl = document.getElementById('error-count');

                if (errorCount === 0) {
                    statusEl.innerHTML = '<span class="success">‚úÖ SUCCESS - No errors detected!</span>';
                    errorCountEl.innerHTML = `<span class="success">Errors: ${errorCount}</span>`;
                } else {
                    statusEl.innerHTML = '<span class="error">‚ùå FAILED - Errors detected</span>';
                    errorCountEl.innerHTML = `<span class="error">Errors: ${errorCount}</span>`;
                }
            }, 100);

        } catch (error) {
            console.error('üí• Fatal error during initialization:', error);
            document.getElementById('status').innerHTML = '<span class="error">‚ùå FATAL ERROR - See console</span>';
            document.getElementById('error-count').innerHTML = `<span class="error">Exception: ${error.message}</span>`;
        }
    </script>
</body>
</html>
